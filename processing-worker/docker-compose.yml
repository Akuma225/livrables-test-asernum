services:
  processing-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: processing-worker
    env_file:
      - .env
    # Fallback si DATABASE_URL / KAFKA_BROKER_URL ne sont pas présents dans processing-worker/.env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql://admin:1234@postgres:5432/asernum-documents-db}
      # Depuis un conteneur, utiliser le listener INTERNAL de kafka (cf kafka/docker-compose.yml)
      KAFKA_BROKER_URL: ${KAFKA_BROKER_URL:-kafka:9093}
    # Prisma db push au démarrage (runtime) + attente DB
    command:
      - sh
      - -c
      - 'i=0; until npx prisma db push; do i=$((i+1)); if [ "$i" -ge 30 ]; then echo "DB non joignable après 60s" >&2; exit 1; fi; echo "En attente de Postgres... ($i/30)"; sleep 2; done; exec node dist/src/main.js'
    ports:
      - "3003:3003"
    networks:
      - asernum

networks:
  asernum:
    name: asernum

